{% extends "base.html" %}

{% block title %}Historique - {{ subject.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0 text-gray-800">
            <i class="bi bi-clock-history me-2"></i>Historique des activités
        </h1>
        <p class="text-muted mb-0">Sujet: <strong>{{ subject.name }}</strong></p>
    </div>
    <div>
        <a href="/gestionnaire/subjects" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-2"></i>Retour aux sujets
        </a>
    </div>
</div>

<div class="card shadow">
    <div class="card-header py-3 bg-light">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-list-ul me-2"></i>Journal des activités
            <span class="badge bg-primary ms-2">{{ activities|length }} activité(s)</span>
        </h6>
    </div>
    <div class="card-body p-0">
        {% if activities %}
            <div class="timeline">
                {% for activity in activities %}
                <div class="timeline-item border-bottom">
                    <div class="row align-items-center py-3 px-4">
                        <div class="col-auto">
                            <div class="timeline-icon
                                {% if activity.action == 'activate_emission' %}bg-success{% endif %}
                                {% if activity.action == 'deactivate_emission' %}bg-secondary{% endif %}
                                {% if activity.action == 'activate_vote' %}bg-primary{% endif %}
                                {% if activity.action == 'close_vote' %}bg-info{% endif %}
                                {% if activity.action == 'abandon_vote' %}bg-warning{% endif %}
                                text-white rounded-circle d-flex align-items-center justify-content-center"
                                style="width: 45px; height: 45px;">
                                {% if activity.action == 'activate_emission' %}
                                    <i class="bi bi-play-circle-fill"></i>
                                {% elif activity.action == 'deactivate_emission' %}
                                    <i class="bi bi-pause-circle-fill"></i>
                                {% elif activity.action == 'activate_vote' %}
                                    <i class="bi bi-hand-thumbs-up-fill"></i>
                                {% elif activity.action == 'close_vote' %}
                                    <i class="bi bi-check-circle-fill"></i>
                                {% elif activity.action == 'abandon_vote' %}
                                    <i class="bi bi-x-circle-fill"></i>
                                {% else %}
                                    <i class="bi bi-gear-fill"></i>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col">
                            <div class="timeline-content">
                                <h6 class="mb-1 fw-bold">{{ activity.description }}</h6>
                                <p class="mb-1 text-muted">
                                    Par <strong>{{ activity.user_name }}</strong> ({{ activity.user_email }})
                                </p>
                                {% if activity.details %}
                                    <small class="text-info">
                                        <i class="bi bi-info-circle me-1"></i>{{ activity.details }}
                                    </small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto text-end">
                            <div class="timeline-date">
                                <small class="text-muted">
                                    <i class="bi bi-calendar3 me-1"></i>
                                    {{ activity.timestamp.strftime('%d/%m/%Y') }}
                                </small>
                                <br>
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>
                                    {{ activity.timestamp.strftime('%H:%M:%S') }}
                                </small>
                                {% if activity.ip_address %}
                                    <br>
                                    <small class="text-muted">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        {{ activity.ip_address }}
                                    </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-clock text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3 text-muted">Aucune activité enregistrée</h5>
                <p class="text-muted">Les activités futures sur ce sujet apparaîtront ici.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Statistiques de l'historique -->
{% if activities %}
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <div class="h4 mb-0">
                    {% set activation_count = 0 %}
                    {% for activity in activities %}
                        {% if activity.action == 'activate_emission' %}
                            {% set activation_count = activation_count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ activation_count }}
                </div>
                <small>Activations émission</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center">
                <div class="h4 mb-0">
                    {% set deactivation_count = 0 %}
                    {% for activity in activities %}
                        {% if activity.action == 'deactivate_emission' %}
                            {% set deactivation_count = deactivation_count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ deactivation_count }}
                </div>
                <small>Désactivations émission</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <div class="h4 mb-0">
                    {% set vote_count = 0 %}
                    {% for activity in activities %}
                        {% if activity.action == 'activate_vote' %}
                            {% set vote_count = vote_count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ vote_count }}
                </div>
                <small>Sessions de vote</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <div class="h4 mb-0">
                    {% set contributors = [] %}
                    {% for activity in activities %}
                        {% if activity.user_email not in contributors %}
                            {% set _ = contributors.append(activity.user_email) %}
                        {% endif %}
                    {% endfor %}
                    {{ contributors|length }}
                </div>
                <small>Contributeurs uniques</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.timeline-item:last-child {
    border-bottom: none !important;
}

.timeline-item:hover {
    background-color: #f8f9fc;
}

.timeline-icon {
    font-size: 1.2rem;
}

.timeline-content h6 {
    color: #5a5c69;
}

.timeline-date {
    min-width: 120px;
}
</style>
{% endblock %}